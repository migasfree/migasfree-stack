#!/bin/bash

# create-metadata <PROJECT> <DEPLOYMENT> <ARCHS>

# example: su -c 'create-metadata "TEST" "pruebas" ' - www-data 

_PROJECT="$1"
_DEPLOYMENT="$2" 
_ARCHS="$3"

if [ -z $_ARCHS ]
then
    _ARCHS=("amd64")
fi 

echo "Creating repository metadata"
echo "========================"
echo "PATH_PUBLIC: $PATH_PUBLIC"
echo "PATH_KEYS: $PATH_KEYS"
echo "PROJECT: $_PROJECT"
echo "DEPLOYMENT: $_DEPLOYMENT"
echo "ARCHS: $_ARCHS"
echo

function calculate_hash {
  echo $1
  _FILES=$(find  -type f | sed 's/^.\///' | sort)
  for _FILE in $_FILES
  do
    _SIZE=$(printf "%16d\n" $(ls -l $_FILE | cut -d ' ' -f5))
    _HASH=$($2 $_FILE | cut -d ' ' -f1) $()
    echo " $_HASH" "$_SIZE" "$_FILE"
  done
}


function create_deploy {
  _F="$(mktemp /var/tmp/deploy-XXXXX)"

  rm Release 2>/dev/null || :
  rm Release.gpg 2>/dev/null || :
  touch Release
  rm $_F 2>/dev/null || :

  echo "Architectures: ${_ARCHS[@]}" > $_F
  echo "Codename: $_DEPLOYMENT" >> $_F
  echo "Components: PKGS" >> $_F
  echo "Date: $(date -u '+%a, %d %b %Y %H:%M:%S UTC')" >> $_F
  echo "Label: migasfree $_DEPLOYMENT repository" >> $_F
  echo "Origin: migasfree" >> $_F
  echo "Suite: $_DEPLOYMENT" >> $_F

  calculate_hash "MD5Sum:" "md5sum" >> $_F
  calculate_hash "SHA1:" "sha1sum" >> $_F
  calculate_hash "SHA256:" "sha256sum" >> $_F
  calculate_hash "SHA512:" "sha512sum" >> $_F

  mv $_F Release

  gpg -u migasfree-repository --homedir $PATH_KEYS/.gnupg --clearsign -o InRelease Release
  gpg -u migasfree-repository --homedir $PATH_KEYS/.gnupg -abs -o Release.gpg Release
}


for _ARCH in ${_ARCHS[@]}
do
  mkdir -p ${PATH_PUBLIC}/${_PROJECT}/TMP/dists/${_DEPLOYMENT}/PKGS/binary-${_ARCH}/
  cd ${PATH_PUBLIC}/${_PROJECT}/TMP/
  dpkg-scanpackages -m dists/${_DEPLOYMENT}/PKGS > dists/${_DEPLOYMENT}/PKGS/binary-${_ARCH}/Packages 
  gzip -9c dists/${_DEPLOYMENT}/PKGS/binary-${_ARCH}/Packages > dists/${_DEPLOYMENT}/PKGS/binary-${_ARCH}/Packages.gz
done

cd ${PATH_PUBLIC}/${_PROJECT}/TMP/dists/${_DEPLOYMENT}/
create_deploy